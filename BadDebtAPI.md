# L3Exchange Bad Debt API
&ensp;&ensp;&ensp;&ensp;本文档主要阐述BadDebt（坏账）产生的原因和对应给出的需求和解决方案的描述和对应的技术解决方案与原理。以及在SDK中API等设计。

## 原因
### 1.坏账的定义
&ensp;&ensp;&ensp;&ensp;
坏账并非bug导致，而是资产划转中多边关系不对等导致的问题，在跨链资产交换的过程中，必定会存在某个Asset在多个网络都存在，比如ETH，在多条公链中都存在该资产并且随着共识的达成程度，在某一个网络中甚至存在多个锚定Ethereum网络中ETH资产的ERC20系列代币等。
<br>&ensp;&ensp;&ensp;&ensp;
在跨链资产交换的工程中，必定会出现资产不平衡导致无法兑付的情况。这种短暂的无法兑付的跨链资产交换交易，我们称之为Bad Debt，即坏账。

### 2.两个网络之间不存在坏账，2+后必然存在
&ensp;&ensp;&ensp;&ensp;
在支持第三个网络之前，双网络之间的资产交换一直保持着一个对等关系，一方网络增加某资产，另一方网络必定减少对应资产，所以不存在坏账。但是在新增加第三个网络时候，就必然会出现不对等的情况。

### 3.坏账产生的例子
&ensp;&ensp;&ensp;&ensp;
举一个简单的例子，假设目前支持网络A/B/C，三个网络中都存在ETH资产，若存在如下跨链资产交换交易，其中B网络中的ETH为PMB（PairMintBurn）代币

```js
[1] A -> B : 100 ETH     // A网络中锁定100ETH， B网络发行对应的100ETH
[2] B -> C : 100 ETH     // B网络中销毁100ETH， C网络中没有锁定的ETH资产
```
&ensp;&ensp;&ensp;&ensp;
这个交易会导致2号交易，无法在C网络中兑付，因为对应锁定的资产存在于A网络中，结合上文对坏账的定义，于是定义2号交易为坏账交易。

### 4.使用“平账”形式处理坏账的解决方案
&ensp;&ensp;&ensp;&ensp;
根据上面的例子，假设有人其他用户在此时进行了一次如下交易

```js
[3] C -> A : 100 ETH     // C网络中锁定了100ETH，A网络中解锁100ETH
```
&ensp;&ensp;&ensp;&ensp;
3号交易完成后，则2号交易也可以顺利完成。此为解决方案的核心逻辑，同时为了鼓励用户主动处理坏账交易，系统设计了一些奖励机制，如手续费的一部给予平账地址等。需要注意的是，若需要操作平账功能来处理坏账，是有独立的接口来进行的，否则系统无法标记用户是处于“平账”或是正常使用状态。

### 5.使用“借款”形式处理非稳定资产坏账解决方案
&ensp;&ensp;&ensp;&ensp;
上面的例子是主流稳定资产的解决方案，但系统中也存在一些新发型的资产，比如新的ERC20资产，在发行前对应的目标网络中，可能还未拥有任何持有地址，显然就不能以上述的解决方案来处理坏账了。
<br>&ensp;&ensp;&ensp;&ensp;
那么发行方可以通过借款形式将资产借给系统，系统会记录一个欠款，
同样假设系统目前支持A/B/C三个网络，最初资产E仅在A网络中发行，并且与B网络中的PMB（PairMintBurn）代币组成了第一个跨链交易对。随后有需求将A/B网络的资产E交换至网络C。
<br>&ensp;&ensp;&ensp;&ensp;
在这个例子中C网络中，显然是没有资产持有地址的，所以没有办法用方式一来处理坏账，若C网络中使用的是一个非PMB协议代币，那么C网络中的资产E的发行方，可以将C网络的资产E借给本系统。系统会形成一个借款记录，用于在资产E分布均匀后进行取回操作。

#### 5.1 可取回的“借款”
&ensp;&ensp;&ensp;&ensp;
案例中，若最后这些借款需要取回则需要使用桥上特定的API接口来进行操作借出，否则将不会形成借款记录，也无法取回（只能通过跨链资产交换按照原有规则进行资产交换）

#### 5.2 不可取回的“借款”
&ensp;&ensp;&ensp;&ensp;
若这些借款不用取回，仅支持通过桥来交换，则可以直接将对应的资产使用`transfer`,`transferFrom`转移给桥合约。


## 安全与策略问题

### 1.防止恶意操作坏账接口，抢夺手续费
&ensp;&ensp;&ensp;&ensp;
坏账处理系列功能和接口在系统运行时是保持开放的状态，为了防止用户使用坏账接口进行常规跨链操作，增加了一个策略，即使用坏账处理接口时候，若桥上已锁定的资产可以完成对应交易的兑付，则不会使用`调用地址`的资产，也不会给予`调用者`任何奖励，即会导致帮系统加速处理了跨链交换交易而又没有获得任何奖励的情况。
<br>&ensp;&ensp;&ensp;&ensp;
通过增加这个策略来防止该问题，整套桥系统在处理快链交易的请求时候，内置的逻辑反应需要时间（网络延迟和区块确认延迟问题），同时处理的过程中也会有其他用户进行交换，所以坏账记录并非是实时有效的，有可能在API查询到的一瞬间确实无法处理，是一个真实的坏账，但是在实际合约执行的瞬间，桥上资产可以处理这个账目。

综合考虑增加了这个策略

### 2.若坏账迟迟不能处理，系统如何处理
&ensp;&ensp;&ensp;&ensp;
超过一定的时间，若桥上资产无法处理该坏账，也没有用户来处理这些坏账，则会按照“欠款”记录给接收方地址，比如A->B 100ETH 超过60分钟，仍然没有办法兑付，系统会记录在B网络中，欠用户100 ETH。欠款可以在桥上资金充足的情况下实时提取，也可以使用欠款作为本金支付交换到其他对应锚定资产充足的网络中去。
<br>&ensp;&ensp;&ensp;&ensp;
同样的，在这个过程中，还会出现，使用欠款额度跨链交换到目标网络后，目标网络因为用户的并发，导致实际到达目标网络后，又出现无法兑付的问题，则按照上述机制，超过一定时间后，继续行程欠款额度在目标网络中。但是从宏观角度来说，桥上资产在各个网络中是对等的，所以一定会有可以兑付的网络提供选择。


## SDK API

### 1.查询指定交易对的当前坏账

```typescript
async function(pair: ExchangePair) : Promise<ExchangeHistory[]>
```

接口返回指定交易对当前存在的坏账，若没有结果则说明暂时没有判断到坏账的存在，若有返回结果，也需要注意上文所说关于坏账的即时性问题。


### 2.借款数量查询

该接口适合批量查询，若仅需要查询对应用户的使用合约接口即时性更强

```typescript
async function(
    fromChain: ChainName, 
    filter: {
        skip?: number,
        first: number,
        where?: { [key: string]: any },
    }): Promise<{
        amount: BN,
        exchangePair: ExchangePair
    }[]>
```

未完待续...